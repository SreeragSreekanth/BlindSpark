{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/chatroom.css' %}">
<link rel="stylesheet" href="{% static 'css/chat_messages.css' %}">


<div class="container py-3 chat-wrapper">
  <div class="card shadow-sm">

    <!-- Header -->
    <div class="card-header d-flex align-items-center bg-dark text-white">

      <a href="{% url 'chat:chat_list' %}" class="text-white me-3">Back</a>

      <img id="profile-photo"
           src="{{ other_user.profile_photo.url|default:'/static/img/avatar.png' }}"
           class="rounded-circle me-2 {% if not match.is_friend %}blur-photo{% endif %}"
           style="width:40px;height:40px;object-fit:cover;">

      <a href="{% url 'matches:view_profile' other_user.id %}" 
         class="text-white fw-bold"
         style="text-decoration:none;">
         {{ other_user.username }}
      </a>

      <div id="reveal-controls" class="ms-auto">
        {% if not match.is_friend %}
          {% if reveal_requested %}
            <button class="btn btn-warning btn-sm" disabled>Requested</button>
          {% elif reveal_request %}
            <button id="accept-btn" class="btn btn-success btn-sm">Accept</button>
          {% else %}
            <button id="request-btn" class="btn btn-primary btn-sm">Request Reveal</button>
          {% endif %}
        {% else %}
          <span class="text-success small">Unblurred</span>
        {% endif %}
      </div>

    </div>

    <!-- Messages -->
    <div id="chat-box" class="card-body p-0 chat-box">
      {% include 'chat/_messages.html' %}
    </div>

    <!-- Input -->
    <div class="card-footer p-3">
      <form id="chat-form">
        {% csrf_token %}
        <div class="input-group">
          <input type="text" name="text" id="msg-input" class="form-control" 
                 placeholder="Type a message..." autocomplete="off">
          <button class="btn btn-dark" type="submit">Send</button>
        </div>
      </form>
    </div>
  </div>

  <div id="delete-popup" class="delete-popup">
    <button class="btn btn-sm w-100 text-start px-3 text-danger"
            onclick="deleteMessage()">
      Delete Message
    </button>
  </div>
</div>

<script>
  const CHAT_FETCH_URL = "{% url 'chat:fetch_messages' chatroom.id %}";
  const CHAT_SEND_URL = "{% url 'chat:send_message' chatroom.id %}";
  const REQUEST_REVEAL_URL = "{% url 'chat:request_reveal' match.id %}";
  const ACCEPT_REVEAL_URL = "{% url 'chat:accept_reveal' match.id %}";
  const CSRF_TOKEN = "{{ csrf_token }}";
</script>

<script src="{% static 'js/chatroom.js' %}"></script>

{% endblock %}
