{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'css/chat_list.css' %}">
<script src="{% static 'js/chat_list.js' %}" defer></script>

<div class="container py-4 chat-list-wrapper">
  <h3 class="mb-4 text-center">Chats</h3>

  <!-- SEARCH -->
  <div class="search-container mb-3">
    <input type="text" id="search-input" class="form-control" placeholder="Search chats..." autocomplete="off">
  </div>

  {% if chatrooms %}
    <div class="list-group">
      {% for c in chatrooms %}
        <a href="{% url 'chat:chatroom' c.room.match.id %}" 
           class="list-group-item list-group-item-action p-3 chat-item"
           data-name="{{ c.other.username|lower }}">

          <div class="d-flex w-100 align-items-center">
            <!-- Avatar -->
            <div class="me-3 position-relative">
              {% if c.other.profile_photo %}
                <img src="{{ c.other.profile_photo.url }}" 
                     class="rounded-circle {% if not c.can_see_photo %}blur-photo{% endif %}"
                     style="width:50px;height:50px;object-fit:cover;">
                {% if not c.can_see_photo %}
                  <div class="blur-overlay"></div>
                {% endif %}
              {% else %}
                <div class="bg-dark text-white rounded-circle d-flex align-items-center justify-content-center"
                     style="width:50px;height:50px;font-size:1.2rem;">
                  {{ c.other.username|first|upper }}
                </div>
              {% endif %}
            </div>

            <!-- Info -->
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold chat-name">{{ c.other.username }}</h6>

                {% if c.last_msg %}
                  <small class="text-muted">{{ c.last_msg.timestamp|date:"H:i" }}</small>
                {% endif %}
              </div>

              <p class="mb-0 text-muted small">
                {% if c.last_msg %}
                  {% if c.last_msg.sender == user %}You: {% endif %}
                  {{ c.last_msg.text|truncatechars:35 }}
                {% else %}
                  Start chatting...
                {% endif %}
              </p>
            </div>

            <!-- Unread -->
            {% if c.unread > 0 %}
              <span class="badge bg-danger rounded-pill ms-2">{{ c.unread }}</span>
            {% endif %}
          </div>

        </a>
      {% endfor %}
    </div>

  {% else %}
    <div class="text-center py-5">
      <p class="text-muted">No chats yet. Start matching!</p>
      <a href="{% url 'matches:discover' %}" class="btn btn-dark">Discover</a>
    </div>
  {% endif %}
</div>

{% endblock %}
